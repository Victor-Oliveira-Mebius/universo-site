<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mensagens Recebidas | Universo Sistemas</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>



     

<header class="flex bg-white sticky top-0 z-50 h-20   hidden md:flex">
  <div class="container mx-auto px-4 py-3 flex justify-between items-center h-full">
    
    <!-- LOGO -->
    <div class="flex items-center space-x-4">
      <a href="#top">
        <img src="./img-sistema/imagem-chat2.png"
             alt="Logo Universo Sistemas"
     class="h-auto max-h-48 w-auto max-w-[160px] sm:max-w-[200px] lg:max-w-[250px]"/>
      </a>
    </div>

</header>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold text-blue-700 mb-6">ğŸ“¬ Mensagens Recebidas</h1>
    <div class="mb-4 flex flex-col md:flex-row gap-3 md:items-center">
      <button id="btn-toggle-filtros" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        ğŸ” Buscar filtros
      </button>
      <button id="btn-excluir-todos" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
        ğŸ—‘ï¸ Excluir todos
      </button>
    </div>
    <div id="filtros-container" class="mb-6 bg-white p-4 rounded shadow hidden">
      <h2 class="font-semibold mb-2">Filtrar mensagens</h2>
      <form id="filtro-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <input type="date" id="filtro-data" class="border rounded px-3 py-2" placeholder="Data (dia)" />
        <input type="text" id="filtro-nome" class="border rounded px-3 py-2" placeholder="Nome" />
        <input type="text" id="filtro-empresa" class="border rounded px-3 py-2" placeholder="Empresa" />
        <input type="text" id="filtro-telefone" class="border rounded px-3 py-2" placeholder="Telefone" />
        <input type="text" id="filtro-sistema" class="border rounded px-3 py-2" placeholder="Sistema (Ex: Uniplus, Sysnop...)" />
        <button type="button" id="btn-limpar" class="col-span-1 md:col-span-3 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
          Limpar filtros
        </button>
      </form>
    </div>
    <div id="tabela-container"></div>
    <div class="mt-10">
      <a href="./form.html" class="text-blue-600 hover:underline">&larr; Voltar ao formulÃ¡rio</a>
    </div>
  </div>
  <script>
    const container = document.getElementById('tabela-container');
    const filtroForm = document.getElementById('filtro-form');
    const filtrosContainer = document.getElementById('filtros-container');
    const toggleBtn = document.getElementById('btn-toggle-filtros');
    const excluirTodosBtn = document.getElementById('btn-excluir-todos');

    toggleBtn.addEventListener('click', () => {
      filtrosContainer.classList.toggle('hidden');
      toggleBtn.textContent = filtrosContainer.classList.contains('hidden') ? 'ğŸ” Buscar filtros' : 'âŒ Ocultar filtros';
    });

    excluirTodosBtn.addEventListener('click', () => {
      if (confirm("Deseja realmente excluir todas as mensagens?")) {
        localStorage.removeItem('clientes');
        renderTabela();
      }
    });

    function formatarDataDisplay(dataStr) {
      const data = new Date(dataStr);
      if (isNaN(data)) return dataStr;
      return data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour:'2-digit', minute:'2-digit' });
    }

    function renderTabela(filtro = {}) {
      let clientes = JSON.parse(localStorage.getItem('clientes')) || [];
      clientes.sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora));
      clientes = clientes.filter(c => {
        if (filtro.data && new Date(c.dataHora).toISOString().split('T')[0] !== filtro.data) return false;
        if (filtro.nome && !c.nome.toLowerCase().includes(filtro.nome.toLowerCase())) return false;
        if (filtro.empresa && !c.empresa.toLowerCase().includes(filtro.empresa.toLowerCase())) return false;
        if (filtro.telefone && !c.telefone.toLowerCase().includes(filtro.telefone.toLowerCase())) return false;
        if (filtro.sistema && !(c.sistema || '').toLowerCase().includes(filtro.sistema.toLowerCase())) return false;
        return true;
      });

      if (clientes.length === 0) {
        container.innerHTML = `<div class="text-gray-500 text-lg">Nenhuma mensagem encontrada.</div>`;
        return;
      }

      let tabela = `
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white shadow-md rounded-lg overflow-hidden">
            <thead class="bg-blue-600 text-white">
              <tr>
                <th class="py-3 px-4 text-left">Nome</th>
                <th class="py-3 px-4 text-left">Email</th>
                <th class="py-3 px-4 text-left">Telefone</th>
                <th class="py-3 px-4 text-left">Empresa</th>
                <th class="py-3 px-4 text-left">Sistema</th>
                <th class="py-3 px-4 text-left max-w-xs">Mensagem</th>
                <th class="py-3 px-4 text-left">Data</th>
                <th class="py-3 px-4 text-left">AÃ§Ãµes</th>
              </tr>
            </thead>
            <tbody>
      `;

      clientes.forEach((c, index) => {
        const mensagemId = `mensagem-${index}`;
        tabela += `
          <tr class="border-b hover:bg-gray-50 align-top">
            <td class="py-3 px-4">${c.nome}</td>
            <td class="py-3 px-4">${c.email}</td>
            <td class="py-3 px-4">${c.telefone}</td>
            <td class="py-3 px-4">${c.empresa}</td>
            <td class="py-3 px-4">${c.sistema || '-'}</td>
            <td class="py-3 px-4 max-w-xs">
              <div class="relative">
                <p id="${mensagemId}" class="message max-h-24 overflow-hidden transition-all duration-300 whitespace-pre-line">${c.mensagem}</p>
                <div class="fade-gradient absolute bottom-0 left-0 w-full h-12 bg-gradient-to-b from-transparent to-white pointer-events-none"></div>
                <button data-target="${mensagemId}" class="toggle-btn text-blue-600 hover:underline mt-2 block">Mostrar mais</button>
              </div>
            </td>
            <td class="py-3 px-4 text-sm text-gray-500">${formatarDataDisplay(c.dataHora)}</td>
            <td class="py-3 px-4">
              <button onclick="excluirCliente(${index})" title="Excluir" class="text-red-600 hover:text-red-800">ğŸ—‘ï¸</button>
            </td>
          </tr>
        `;
      });

      tabela += `</tbody></table></div>`;
      container.innerHTML = tabela;

      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const targetId = btn.getAttribute('data-target');
          const paragrafo = document.getElementById(targetId);
          const isCollapsed = paragrafo.classList.contains('max-h-24');
          paragrafo.classList.toggle('max-h-24');
          paragrafo.classList.toggle('max-h-full');
          const gradient = paragrafo.nextElementSibling;
          if (gradient) gradient.style.display = isCollapsed ? 'none' : 'block';
          btn.textContent = isCollapsed ? 'Mostrar menos' : 'Mostrar mais';
        });
      });
    }

    function excluirCliente(index) {
      if (confirm("Tem certeza que deseja excluir?")) {
        let clientes = JSON.parse(localStorage.getItem('clientes')) || [];
        clientes.splice(index, 1);
        localStorage.setItem('clientes', JSON.stringify(clientes));
        renderTabela(pegarFiltros());
      }
    }

    function pegarFiltros() {
      return {
        data: document.getElementById('filtro-data').value,
        nome: document.getElementById('filtro-nome').value.trim(),
        empresa: document.getElementById('filtro-empresa').value.trim(),
        telefone: document.getElementById('filtro-telefone').value.trim(),
        sistema: document.getElementById('filtro-sistema').value.trim()
      };
    }

    filtroForm.addEventListener('input', () => {
      renderTabela(pegarFiltros());
    });

    document.getElementById('btn-limpar').addEventListener('click', () => {
      filtroForm.reset();
      renderTabela();
    });

    renderTabela();
    history.replaceState(null, null, window.location.pathname);
  </script>
</body>
</html>